---
title: 'Novikov_SK HW #6'
output: html_document
date: "2024-04-17"
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Задание 1

Для решения этого задания нам необходимо рассчитать размер выборки для
исследования терапевтической эквивалентности с использованием
двухпериодного кроссоверного дизайна. Исходные данные: дисперсия
($\sigma_m = 0.20$), разница средних ($\varepsilon = -0.10$), клинически
значимая разница ($\delta = 0.25$), уровень значимости (α = 0.05) и
мощность (1-β = 0.80). Также необходимо учитывать 10% drop-out rate.

1.  **Вычислим Z-значения для уровня значимости и мощности.**\
    Обычно для α = 0.05, $Z_{\alpha/2}$ (для двустороннего теста) равно
    1.96, а для β = 0.20, $Z_\beta$ примерно равно 0.84.

2.  **Подставляем все значения в формулу:** $$
    n_1 = n_2 = \frac{(Z_{\alpha/2} + Z_\beta)^2 \sigma_m^2}{2(\delta - |\varepsilon|)^2}
    $$ Подставляя значения: $$
    n_1 = n_2 = \frac{(1.96 + 0.84)^2 \times 0.20^2}{2 \times (0.25 - |-0.10|)^2} = \frac{(2.80)^2 \times 0.04}{2 \times (0.25 - 0.10)^2} = \frac{7.84 \times 0.04}{2 \times 0.15^2}
    $$ $$
    n_1 = n_2 = \frac{0.3136}{2 \times 0.0225} = \frac{0.3136}{0.045} \approx 6.97
    $$

3.  **Коррекция на drop-out rate (10%):** Поскольку мы рассчитали, что
    нам нужно примерно 1.28 участников в каждой группе без учета
    drop-out rate, финальный размер выборки для каждой группы после
    коррекции будет: $$
    n_1 = n_2 = \frac{6.97}{1 - 0.10} = \frac{6.97}{0.90} \approx 7.74
    $$ Так как количество участников не может быть дробным, округлим в
    большую сторону до целого числа. Таким образом, каждой группе
    необходимо примерно 8 участника.

4.  **Итоговый размер выборки для исследования:** $$
    n = n_1 + n_2 = 8 + 8 = 16
    $$

Теперь давайте перенесем эти расчеты в код на R для проверки:

```{R}
# Значения Z
Z_alpha_over_2 <- qnorm(0.975)  # Для α = 0.05 в двустороннем тесте
Z_beta <- qnorm(0.80)  # Для β = 0.20

# Исходные значения
sigma_m <- 0.20
epsilon <- -0.10
delta <- 0.25

# Расчет размера выборки
n1_n2 <- ((Z_alpha_over_2 + Z_beta)^2 * sigma_m^2) / (2 * (delta - abs(epsilon))^2)
n1_n2_corrected <- n1_n2 / (1 - 0.10)  # Учет drop-out rate

# Округление до ближайшего большего целого
n1_n2_final <- ceiling(n1_n2_corrected)
total_n <- 2 * n1_n2_final

# Вывод результатов
cat("Необходимый размер выборки для каждой группы (с учетом drop-out):", n1_n2_final, "\n")
cat("Итоговый размер выборки для исследования:", total_n, "\n")
```

## Задание 2

Для расчёта размера выборки для гипотезы non-inferiority в
двухвыборочном параллельном дизайне, где $\delta = -0.1$ указывает на
клинически значимую разницу в -10%, мы используем данные $p_1 = 0.85$ и
$p_2 = 0.65$. Мы также знаем, что соотношение групп $k = 1$, что
означает равное количество участников в каждой группе. Уровень
значимости (α) обычно составляет 0.05, а мощность (1-β) 0.80.

**Формула размера выборки:** $$
n_1 = n_2 = \frac{(Z_{\alpha / 2} + Z_\beta)^2 \left(p_1(1 - p_1) + p_2(1 - p_2)\right)}{(p_1 - p_2 - \delta)^2}
$$

**Вычислим Z-значения:** - Для уровня значимости $\alpha = 0.05$,
используем двусторонний тест, т.е.
$Z_{\alpha/2} = qnorm(1 - 0.05/2) \approx 1.96$. - Для мощности 0.80,
$Z_\beta = qnorm(0.80) \approx 0.84$.

**Подставляем данные в формулу:** $$
n_1 = n_2 = \frac{(1.96 + 0.84)^2 \left(0.85 \times 0.15 + 0.65 \times 0.35\right)}{(0.85 - 0.65 + 0.1)^2}
$$

**Расчёт:** $$
n_1 = n_2 = \frac{(2.80)^2 \left(0.1275 + 0.2275\right)}{0.3^2} = \frac{7.84 \times 0.355}{0.09} = \frac{2.7832}{0.09} \approx 30.924
$$

Для обеспечения необходимой мощности, каждой группе требуется около 31
участника. Округляя до ближайшего большего целого числа, получаем:

$$ n_1 = n_2 = 31 $$

Итоговый размер выборки (учитывая, что $n = n_1 + n_2$ и $k = 1$):

$$ n = 31 + 31 = 62 $$

Теперь приведем код на R, который выполнит этот расчёт:

```{R}
# Значения Z
Z_alpha_over_2 <- qnorm(0.975)  # Для α = 0.05 в двустороннем тесте
Z_beta <- qnorm(0.80)  # Для β = 0.20

# Исходные значения
p1 <- 0.85
p2 <- 0.65
delta <- -0.1

# Расчет размера выборки
n1_n2 <- ((Z_alpha_over_2 + Z_beta)^2 * (p1 * (1 - p1) + p2 * (1 - p2))) / ((p1 - p2 - delta)^2)
n1_n2_final <- ceiling(n1_n2)  # Округление в большую сторону
total_n <- 2 * n1_n2_final

# Вывод результатов
cat("Необходимый размер выборки для каждой группы:", n1_n2_final, "\n")
cat("Итоговый размер выборки для исследования:", total_n, "\n")
```

## Задание 3

Для расчёта размера выборки для гипотезы equality в исследовании, где
целью является сравнение новой терапии с золотым стандартом с
использованием регрессии Кокса, используем данные о hazard ratio (HR =
2) и вероятность события (d = 0.8). Соотношение групп составляет 1:1 (p1
= p2 = 0.5).

**Формула размера выборки:** $$
n_1 = n_2 = \frac{(Z_{\alpha / 2} + Z_\beta)^2}{\ln (HR)^2 p_1 p_2 d}
$$

**Значения Z для стандартных уровней:** - Уровень значимости (α) = 0.05
(для двустороннего теста), поэтому
$Z_{\alpha / 2} = qnorm(1 - 0.05/2) \approx 1.96$. - Мощность
исследования (1-β) = 0.80, следовательно
$Z_β = qnorm(0.80) \approx 0.84$.

**Подставляем и рассчитываем:** $$
\ln(HR) = \ln(2) \approx 0.693
$$ $$
n_1 = n_2 = \frac{(1.96 + 0.84)^2}{(0.693)^2 \times 0.5 \times 0.5 \times 0.8} = \frac{(2.80)^2}{0.693^2 \times 0.2} = \frac{7.84}{0.4809 \times 0.2} \approx \frac{7.84}{0.09618} \approx 81.51
$$

Округляем до ближайшего большего целого числа: $$ n_1 = n_2 = 82 $$
$$ n = n_1 + n_2 = 164 $$

**Код на R для вычисления размера выборки:**

```{R}
# Значения Z
Z_alpha_over_2 <- qnorm(0.975)  # Для α = 0.05
Z_beta <- qnorm(0.80)          # Для мощности 0.80

# Исходные значения
HR <- 2
d <- 0.8
p1 <- 0.5
p2 <- 0.5

# Расчет размера выборки
n1_n2 <- (Z_alpha_over_2 + Z_beta)^2 / (log(HR)^2 * p1 * p2 * d)
n1_n2_final <- ceiling(n1_n2)  # Округление вверх до целого числа

# Итоговый размер выборки для исследования
total_n <- 2 * n1_n2_final

# Вывод результатов
cat("Необходимый размер выборки для каждой группы:", n1_n2_final, "\n")
cat("Итоговый размер выборки для исследования:", total_n, "\n")
```
